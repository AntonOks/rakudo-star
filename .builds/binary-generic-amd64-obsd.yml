image: openbsd/latest
arch: amd64
packages:
  - gcc
secrets:
  - 53a0d643-e454-4f3b-96af-9ca28cfd6ddd
tasks:
  - prepare: |
      mkdir -p "/tmp/ci-$JOB_ID"
      mkdir -p ~/.ssh
      cat <<-EOF > ~/.ssh/config
      StrictHostKeyChecking no
      UserKnownHostsFile /dev/null
      EOF
      curl -L http://cpanmin.us | doas perl - App::cpanminus
      doas cpanm -v ExtUtils::Command Pod::Usage
  - build: |
      ./rakudo-star/bin/rstar fetch
      ./rakudo-star/bin/rstar install -p "/tmp/ci-$JOB_ID"
  - package: |
      COMMIT="$(git -C rakudo-star rev-parse HEAD)"
      SOURCE_DATE_EPOCH="$(git -C rakudo-star log -1 --pretty=format:%at)"
      cd -- "/tmp/ci-$JOB_ID"
      tar -cf - . | gzip -9cn > "/tmp/rakudo-star-amd64-obsd-$COMMIT.tar.gz"
  - upload: |
      scp /tmp/rakudo-star-amd64-obsd-*.tar.gz dist@dist.tyil.net:raku/star-build
