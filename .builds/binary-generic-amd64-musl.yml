image: alpine/latest
packages:
  - bash
  - gcc
  - libc-dev
  - make
  - perl
secrets:
  - 53a0d643-e454-4f3b-96af-9ca28cfd6ddd
tasks:
  - prepare: |
      mkdir -p "/tmp/ci-$JOB_ID"
      mkdir -p ~/.ssh
      cat <<-EOF > ~/.ssh/config
      StrictHostKeyChecking no
      UserKnownHostsFile /dev/null
      EOF
  - build: |
      ./rakudo-star/bin/rstar fetch
      ./rakudo-star/bin/rstar install -p "/tmp/ci-$JOB_ID"
  - package: |
      COMMIT="$(git -C rakudo-star rev-parse HEAD)"
      SOURCE_DATE_EPOCH="$(git -C rakudo-star log -1 --pretty=format:%at)"
      cd -- "/tmp/ci-$JOB_ID"
      tar -c \
        --mtime "@$SOURCE_DATE_EPOCH" \
        --mode=go=rX,u+rw,a-s \
        --format=gnu \
        --numeric-owner --owner=0 --group=0 \
        . \
        | gzip -9cn \
        > "/tmp/rakudo-star-amd64-musl-$COMMIT.tar.gz"
  - upload: |
      scp /tmp/rakudo-star-amd64-musl-*.tar.gz dist@dist.tyil.net:raku/star-build
